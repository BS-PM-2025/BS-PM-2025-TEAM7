<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #FFFFFF;
      color: #1f2328;
      line-height: 1.5;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 16px 10%;
      background-color: #ffffff;
      border-bottom: 1px solid #d8dee4;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-img {
      height: 32px;
      width: 32px;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: #657EEF;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 24px;
    }

    .nav-links li a {
      text-decoration: none;
      color: #1f2328;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 0;
      position: relative;
    }

    .nav-links li a:hover {
      color: #657EEF;
    }

    .nav-links li a.active {
      color: #657EEF;
    }

    .nav-links li a.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #657EEF;
    }

    .page-container {
      display: flex;
      padding-top: 80px;
      min-height: calc(100vh - 80px);
      gap: 20px;
      padding: 80px 20px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 20px;
    }

    /* Profile Card Styles */
    .profile-card {
      background-color: #657EEF;
      border-radius: 16px;
      padding: 30px;
      color: #FFFFFF;
      width: 100%;
      position: relative;
      box-shadow: 0 4px 12px rgba(91, 118, 247, 0.2);
    }

    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .profile-title {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .profile-info {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .profile-info p {
      margin-bottom: 5px;
      font-size: 16px;
    }

    .edit-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #FFFFFF;
      font-size: 20px;
    }

    .avatar-container {
      display: flex;
      align-items: center;
      margin-top: 20px;
      position: relative;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #e99f6b;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 20px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-initials {
      color: white;
      font-size: 24px;
      font-weight: bold;
    }

    .avatar-decoration {
      position: absolute;
      bottom: -10px;
      width: 100%;
      height: 20px;
      background-color: #4cceac;
      border-radius: 10px;
      z-index: -1;
    }

    .level-container {
      display: flex;
      flex-direction: column;
    }

    .level-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .level-value {
      color: #4cceac;
      font-weight: 600;
    }

    .learn-more {
      color: #FFFFFF;
      font-size: 14px;
      text-decoration: none;
      opacity: 0.8;
    }

    .learn-more:hover {
      opacity: 1;
      text-decoration: underline;
    }

    /* Medal Styles */
    .medal-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
      margin-left: 200px;
    }

    .medal {
      width: 80px;
      height: 80px;
      position: relative;
      margin-bottom: 10px;
    }

    .medal-circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .medal-ribbon {
      position: absolute;
      width: 30px;
      height: 60px;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ffd700;
      clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 70%, 0 100%);
      z-index: 0;
    }

    .medal.gold .medal-circle {
      background: radial-gradient(circle at 30% 30%, #ffd700, #daa520);
      box-shadow: 0 4px 8px rgba(218, 165, 32, 0.4);
    }

    .medal.silver .medal-circle {
      background: radial-gradient(circle at 30% 30%, #c0c0c0, #a0a0a0);
      box-shadow: 0 4px 8px rgba(160, 160, 160, 0.4);
    }

    .medal.bronze .medal-circle {
      background: radial-gradient(circle at 30% 30%, #cd7f32, #a0522d);
      box-shadow: 0 4px 8px rgba(160, 82, 45, 0.4);
    }

    .medal-text {
      color: white;
      font-weight: bold;
      font-size: 24px;
    }

    .medal-label {
      font-size: 14px;
      font-weight: 600;
      color: #FFFFFF;
      text-align: center;
    }

    /* Content Card */
    .content-card {
      background-color: #FFFFFF;
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .content-title {
      font-size: 24px;
      font-weight: 600;
      color: #657EEF;
      margin-bottom: 20px;
    }

    .content-text {
      color: #333;
      margin-bottom: 20px;
    }

    .start-button {
      display: inline-block;
      background-color: #657EEF;
      color: #FFFFFF;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .start-button:hover {
      background-color: #4a65e6;
    }

    /* Game Categories Card */
    .stats-card {
      background-color: #FFFFFF;
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .completion-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
      width: 100%;
    }

    .progress-circle {
      position: relative;
      width: 150px;
      height: 150px;
      margin-bottom: 20px;
    }

    .progress-circle svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .progress-circle-bg {
      fill: none;
      stroke: #f0f0f0;
      stroke-width: 12;
    }

    .progress-circle-fill {
      fill: none;
      stroke: #4cceac;
      stroke-width: 12;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: calc(283 - (283 * var(--progress-percent)) / 100);
      transition: stroke-dashoffset 0.5s ease-out;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .progress-percentage {
      font-size: 24px;
      font-weight: 600;
      color: #657EEF;
    }

    .progress-label {
      font-size: 14px;
      color: #666;
    }

    .categories-title {
      font-size: 20px;
      font-weight: 600;
      color: #657EEF;
      margin-bottom: 20px;
      text-align: center;
      width: 100%;
    }

    .category-list {
      width: 100%;
    }

    .category-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #65EFBC;
      width: 100%;
    }

    .category-info {
      flex: 1;
    }

    .category-name {
      font-size: 16px;
      font-weight: 500;
      color: #657EEF;
      margin-bottom: 5px;
    }

    .category-progress {
      width: 100%;
      height: 6px;
      background-color: #FFFFFF;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }

    .category-progress-fill {
      height: 100%;
      background-color: #4cceac;
      border-radius: 3px;
    }

    .category-activity {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    .category-arrow {
      color: #657EEF;
      font-size: 20px;
      margin-left: 10px;
    }

    .view-all-link {
      display: block;
      text-align: right;
      color: #657EEF;
      font-size: 14px;
      text-decoration: none;
      margin-top: 10px;
      width: 100%;
    }

    .view-all-link:hover {
      text-decoration: underline;
    }

    /* Quiz Results Styles */
    .quiz-results-section {
      background-color: #FFFFFF;
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-top: 20px;
    }

    .quiz-results-title {
      font-size: 20px;
      font-weight: 600;
      color: #657EEF;
      margin-bottom: 20px;
    }

    .quiz-result-card {
      background-color: #ffffff;
      border-left: 5px solid #657EEF;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .quiz-result-card h4 {
      font-size: 16px;
      color: #1f2328;
      margin-bottom: 10px;
    }

    .quiz-result-card p {
      font-size: 14px;
      color: #444;
      margin: 4px 0;
    }

    .correct {
      color: green;
      font-weight: bold;
    }

    .incorrect {
      color: red;
      font-weight: bold;
    }

    /* Photo Upload Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }

    .upload-btn {
      background-color: #657EEF;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }

    .upload-btn:hover {
      background-color: #4a65e6;
    }

    /* Photo View Modal */
    .photo-modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }

    .photo-modal-content {
      max-width: 80%;
      max-height: 80%;
    }

    .photo-modal-content img {
      width: 100%;
      height: auto;
      max-height: 80vh;
      border-radius: 8px;
    }

    .close-photo {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }

    /* New styles for edit profile feature */
    #usernameInput, #emailInput {
      font-size: 16px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 2px solid #657EEF;
      outline: none;
      width: 220px;
      transition: border-color 0.3s ease;
    }

    #usernameInput:focus, #emailInput:focus {
      border-color: #4a65e6;
      box-shadow: 0 0 8px rgba(101, 126, 239, 0.5);
    }

    .cancel-btn {
      background-color: transparent;
      border: 2px solid white;
      color: white;
      font-weight: 600;
      border-radius: 8px;
      padding: 6px 14px;
      margin-left: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .cancel-btn:hover {
      background-color: white;
      color: #657EEF;
    }

    .edit-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #FFFFFF;
      font-size: 24px;
      transition: color 0.3s ease;
      padding: 6px;
      border-radius: 50%;
    }

    .edit-icon:hover {
      color: #4a65e6;
      background-color: rgba(255, 255, 255, 0.15);
    }

    .edit-icon.save-mode {
      color: #4cceac;
      font-weight: 700;
      font-size: 18px;
      padding: 8px 16px;
      border-radius: 8px;
      background-color: white;
      color: #657EEF;
      border: 2px solid #657EEF;
      width: 80px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .edit-icon.save-mode:hover {
      background-color: #657EEF;
      color: white;
    }

    @media (max-width: 1024px) {
      .page-container {
        flex-direction: column;
      }
      
      .stats-card {
        max-width: 100%;
        margin-top: 20px;
        order: 3;
      }
    }

    @media (max-width: 768px) {
      .page-container {
        padding: 80px 15px 20px;
      }
      
      .profile-header {
        flex-direction: column;
      }
      
      .avatar-container {
        margin-top: 20px;
      }
      
      .profile-info {
        flex-direction: column;
      }
      
      .medal-container {
        margin-top: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <svg class="logo-img" viewBox="0 0 24 24" fill="#657EEF" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.652.242 2.873.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
      </svg>
      <span class="logo-text">CI/CD</span>
      <ul class="nav-links" id="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>
  </header>

  <div class="page-container">
    <!-- Main Content (Left) -->
    <div class="main-content">
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-header">
          <h1 class="profile-title">Good Morning <span id="username">Yair</span></h1>
          <button class="edit-icon" id="editProfileBtn" title="Edit profile">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16.293 2.293L17.707 3.707L9 12.414L7.586 11L16.293 2.293ZM19.707 6.707L18.293 5.293L20 3.586L21.414 5L19.707 6.707ZM3 13V16H6L17.586 4.414L14.586 1.414L3 13ZM0 21H24V23H0V21Z" fill="white"/>
            </svg>
          </button>
        </div>
        
        <div class="profile-info">
          <div>
            <p><strong>Username:</strong> <span id="username2">Yair Levi</span></p>
            <p><strong>Email:</strong> <span id="email">Yairle@gmail.com</span></p>
            <p><strong>Role:</strong> <span id="role">Student</span></p>
          </div>
          
          <div class="medal-container">
            <div class="medal gold" id="levelMedal">
              <div class="medal-ribbon"></div>
              <div class="medal-circle">
                <div class="medal-text">1</div>
              </div>
            </div>
            <div class="medal-label">Current Level</div>
          </div>
        </div>
        
        <div class="avatar-container">
          <div class="avatar" id="avatarContainer">
            <div class="avatar-initials" id="avatarInitials">YL</div>
            <div class="avatar-decoration"></div>
          </div>
          
          <div class="level-container">
            <div class="level-title">Level: <span class="level-value" id="levelText">Beginner</span></div>
             <a href="#" class="learn-more" id="uploadPhotoLink">Upload Photo</a>
            <a href="#" class="learn-more" id="deletePhotoLink" style="margin-left:8px">Delete Photo</a>
          </div>
        </div>
      </div>
      
      <!-- Content Card (Under Profile Card) -->
      <div class="content-card">
        <h2 class="content-title">Ready to Play, Learn, and Level Up?</h2>
        <p class="content-text">Learn Git the fun way through interactive memory games and quick trivia challenges! You'll match terms with their meanings, answer real world coding questions, and build confidence as you go.</p>
        <p class="content-text">The experience is short, smart, and stress free - perfect for beginners and curious minds alike.</p>
        <p class="content-text">So go ahead choose a topic, start a game, and level up your skills with every move</p>
        <a href="/about" class="start-button">Start Here</a>
      </div>

      <!-- Quiz Results Section -->
      <div class="quiz-results-section">
        <h2 class="quiz-results-title">📊 Your Quiz Submissions</h2>
        <div id="quizResultsContainer"></div>
      </div>
    </div>
    
    <!-- Game Categories Card (Right) -->
    <div class="stats-card">
      <div class="completion-container">
        <div class="progress-circle">
          <svg viewBox="0 0 100 100">
            <circle class="progress-circle-bg" cx="50" cy="50" r="45"></circle>
            <circle class="progress-circle-fill" cx="50" cy="50" r="45" style="--progress-percent: 70;"></circle>
          </svg>
          <div class="progress-text">
            <div class="progress-percentage" id="progressPercent">70%</div>
            <div class="progress-label">Completion</div>
          </div>
        </div>
      </div>
      
      <h2 class="categories-title">Game Categories</h2>
      
      <div class="category-list">
        <div class="category-item">
          <div class="category-info">
            <div class="category-name">Git Basics Match</div>
            <div class="category-progress">
              <div class="category-progress-fill" style="width: 60%;"></div>
            </div>
            <div class="category-activity">Last activity: 3 days ago</div>
          </div>
          <div class="category-arrow">▶</div>
        </div>
        
        <div class="category-item">
          <div class="category-info">
            <div class="category-name">GitHub Match Up</div>
            <div class="category-progress">
              <div class="category-progress-fill" style="width: 40%;"></div>
            </div>
            <div class="category-activity">Last activity: 8 days ago</div>
          </div>
          <div class="category-arrow">▶</div>
        </div>
        
        <a href="#" class="view-all-link">View all</a>
      </div>
    </div>
  </div>

  <!-- Photo Upload Modal -->
  <div id="photoModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Upload Profile Photo</h2>
      <input type="file" id="photoInput" accept="image/*">
      <button class="upload-btn" id="uploadBtn">Upload</button>
    </div>
  </div>

  <!-- Photo View Modal -->
  <div id="viewPhotoModal" class="photo-modal">
    <span class="close-photo">&times;</span>
    <div class="photo-modal-content">
      <img id="enlargedPhoto" src="" alt="Enlarged Profile Photo">
    </div>
  </div>

  <script>
    function goHome() {
      window.location.href = "/";
    }

    function logout() {
      sessionStorage.removeItem("token");
      window.location.href = "/login";
    }

      function parseJwt(token) {
      try { return JSON.parse(atob(token.split('.')[1])); }
      catch { return null; }
    }

    const storedToken = sessionStorage.getItem("token");
    const user       = storedToken && parseJwt(storedToken);
    const userId     = user?.id;                              // make sure your JWT includes `id`
    const photoKey   = userId ? `profilePhoto_${userId}` : null;

    // Function to update medal based on level
    function updateMedal(level) {
      const medal = document.getElementById('levelMedal');
      const levelText = document.getElementById('levelText');
      
      // Remove all medal classes first
      medal.classList.remove('gold', 'silver', 'bronze');
      
      // Determine medal type based on level
      if (level == 100) {
        medal.classList.add('gold');
        levelText.textContent = 'Advanced';
        medal.querySelector('.medal-text').textContent = '1';
      } else if (level >= 50) {
        medal.classList.add('silver');
        levelText.textContent = 'Intermediate';
        medal.querySelector('.medal-text').textContent = '2';
      } else {
        medal.classList.add('bronze');
        levelText.textContent = 'Beginner';
        medal.querySelector('.medal-text').textContent = '3';
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('photoModal');
      const uploadLink = document.getElementById('uploadPhotoLink');
      const closeBtn = document.querySelector('.close');
      const uploadBtn = document.getElementById('uploadBtn');
      const photoInput = document.getElementById('photoInput');
      const avatarContainer = document.getElementById('avatarContainer');
      const avatarInitials = document.getElementById('avatarInitials');
      const viewPhotoModal = document.getElementById('viewPhotoModal');
      const enlargedPhoto = document.getElementById('enlargedPhoto');
      const closePhotoModal = document.querySelector('.close-photo');

      // Load saved photo from localStorage if exists
      const savedPhoto = photoKey && localStorage.getItem(photoKey);
      if (savedPhoto) {
        avatarContainer.innerHTML = `<img src="${savedPhoto}" alt="Profile Photo">`;
        avatarInitials.style.display = 'none';
      }

      // Open modal when upload link is clicked
      uploadLink.addEventListener('click', function(e) {
        e.preventDefault();
        modal.style.display = 'block';
      });

      // Close modal when X is clicked
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });

      // Close modal when clicking outside of it
      window.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Handle photo upload
      uploadBtn.addEventListener('click', function() {
        const file = photoInput.files[0];
        if (file && photoKey) {
          const reader = new FileReader();
          reader.onload = function(e) {
            // Save photo to localStorage
            localStorage.setItem(photoKey, e.target.result);

            
            // Display the photo
            avatarContainer.innerHTML = `<img src="${e.target.result}" alt="Profile Photo">`;
            avatarInitials.style.display = 'none';
            
            // Close modal
            modal.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      });
      // ─── wire up delete link ─────────────────────────────────────────
        const deleteLink = document.getElementById('deletePhotoLink');
        deleteLink.addEventListener('click', e => {
          e.preventDefault();
          if (!photoKey) return;
          localStorage.removeItem(photoKey);

          // restore initials
          const initials = avatarInitials.textContent;
          avatarContainer.innerHTML = `
            <div class="avatar-initials">${initials}</div>
            <div class="avatar-decoration"></div>
          `;
        });

      // Handle clicking on avatar to view enlarged photo
      avatarContainer.addEventListener('click', function(e) {
       const savedPhoto = photoKey && localStorage.getItem(photoKey);
        if (savedPhoto) {
          enlargedPhoto.src = savedPhoto;
          viewPhotoModal.style.display = 'flex';
        }
      });

      // Close photo view modal
      closePhotoModal.addEventListener('click', function() {
        viewPhotoModal.style.display = 'none';
      });

      // Close photo view modal when clicking outside
      window.addEventListener('click', function(e) {
        if (e.target === viewPhotoModal) {
          viewPhotoModal.style.display = 'none';
        }
      });
    });

    // Check if token exists in session storage
    const token = sessionStorage.getItem("token");
    
    // If token exists, parse it and update user info
    if (token) {
      const user = parseJwt(token);
      
      if (user) {
        document.getElementById("username").textContent = user.username || "Yair";
        document.getElementById("username2").textContent = user.username || "Yair Levi";
        document.getElementById("email").textContent = user.email || "Yairle@gmail.com";
        document.getElementById("role").textContent = user.role || "Student";
        
        // Update avatar initials based on username
        const username = user.username || "Yair Levi";
        const initials = username.split(' ').map(n => n[0]).join('').toUpperCase();
        document.getElementById("avatarInitials").textContent = initials;
        
        fetchStudentProgress();
        fetchQuizHistory();
      }
    }

    // Function to fetch student progress
    function fetchStudentProgress() {
      if (!token) return;
      
      const user = parseJwt(token);
      if (!user) return;

      fetch(`/api/progress/${user.id}`, {
        headers: {
          Authorization: "Bearer " + token
        }
      })
      .then(res => res.json())
      .then(data => {
        let percentage = 0;

        // Case 1: list of quizzes with scores -> calculate average
        if (Array.isArray(data) && data.length > 0) {
          const total = data.reduce((sum, entry) => sum + entry.percentage, 0);
          percentage = Math.round(total / data.length);
        }

        // Case 2: single value from backend
        if (data.averagePercentage) {
          percentage = Math.round(data.averagePercentage);
        }

        // Update UI
        document.getElementById("progressPercent").textContent = `${percentage}%`;
        document.querySelector(".progress-circle-fill").style.setProperty('--progress-percent', percentage);
        
        // Update medal based on percentage
        updateMedal(percentage);
      })
      .catch(err => {
        console.error("Failed to fetch progress:", err);
      });
    }

    // Function to fetch quiz history
    function fetchQuizHistory() {
      if (!token) return;

      fetch("/api/submissions", {
        headers: {
          Authorization: "Bearer " + token
        }
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("quizResultsContainer");
        if (!Array.isArray(data) || data.length === 0) {
          container.innerHTML = `<p>No quiz history found.</p>`;
          return;
        }

        data.forEach(entry => {
          const card = document.createElement("div");
          card.className = "quiz-result-card";

          let questionsHtml = '';
          if (entry.results && Array.isArray(entry.results)) {
            questionsHtml = entry.results.map(result => `
              <p><strong>${result.prompt}</strong></p>
              <p>Your Answer: <span class="${result.isCorrect ? 'correct' : 'incorrect'}">${result.studentAnswer}</span></p>
              <p>Correct Answer: <strong>${result.correctAnswer}</strong></p>
              <hr>
            `).join("");
          }

          card.innerHTML = `
            <h4>Video ID: ${entry.videoTitle || entry.videoId}</h4>
            <p>Score: <strong>${entry.score}%</strong></p>
            ${questionsHtml}
          `;

          container.appendChild(card);
        });
      })
      .catch(err => {
        console.error("Error loading quiz history:", err);
      });
    }

    // Profile edit and save logic
   document.getElementById("editProfileBtn").addEventListener("click", handleEditClick);

function handleEditClick() {
  // Convert text spans to input fields
  const usernameSpan = document.getElementById("username2");
  const emailSpan = document.getElementById("email");

  const usernameInput = document.createElement("input");
  usernameInput.type = "text";
  usernameInput.value = usernameSpan.textContent;
  usernameInput.id = "usernameInput";

  const emailInput = document.createElement("input");
  emailInput.type = "email";
  emailInput.value = emailSpan.textContent;
  emailInput.id = "emailInput";

  usernameSpan.parentNode.replaceChild(usernameInput, usernameSpan);
  emailSpan.parentNode.replaceChild(emailInput, emailSpan);

  const editBtn = document.getElementById("editProfileBtn");
  editBtn.textContent = "Save";
  editBtn.classList.add("save-mode");

  // Remove old click listener and add save listener
  editBtn.removeEventListener("click", handleEditClick);
  editBtn.addEventListener("click", saveProfile, { once: true });

  // Create and add cancel button next to save button
  let cancelBtn = document.createElement("button");
  cancelBtn.textContent = "Cancel";
  cancelBtn.className = "cancel-btn";

  editBtn.parentNode.insertBefore(cancelBtn, editBtn.nextSibling);

  // Cancel button event: revert UI to original
  cancelBtn.addEventListener("click", () => {
    // Replace inputs back to spans
    usernameInput.parentNode.replaceChild(usernameSpan, usernameInput);
    emailInput.parentNode.replaceChild(emailSpan, emailInput);

    // Revert save button to edit icon
    editBtn.textContent = "";
    editBtn.innerHTML = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" 
        xmlns="http://www.w3.org/2000/svg">
        <path d="M16.293 2.293L17.707 3.707L9 12.414L7.586 11L16.293 2.293ZM
                 19.707 6.707L18.293 5.293L20 3.586L21.414 5L19.707 6.707ZM
                 3 13V16H6L17.586 4.414L14.586 1.414L3 13ZM0 21H24V23H0V21Z" 
          fill="white"/>
      </svg>
    `;
    editBtn.classList.remove("save-mode");

    // Remove cancel button from DOM
    cancelBtn.remove();

    // Remove save listener and add edit listener back
    editBtn.removeEventListener("click", saveProfile);
    editBtn.addEventListener("click", handleEditClick);
  });
}

function saveProfile() {
  const newUsername = document.getElementById("usernameInput").value.trim();
  const newEmail = document.getElementById("emailInput").value.trim();

  if (!newUsername || !newEmail) {
    alert("Username and Email cannot be empty.");
    return;
  }

  const editBtn = document.getElementById("editProfileBtn");
  const usernameInput = document.getElementById("usernameInput");
  const emailInput = document.getElementById("emailInput");

  fetch('/api/users/updateProfile', {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + sessionStorage.getItem("token")
    },
    body: JSON.stringify({ username: newUsername, email: newEmail })
  })
  .then(response => {
    if (!response.ok) throw new Error('Failed to update profile');
    return response.json();
  })
  .then(data => {
    alert("Profile updated successfully!");

    // Replace inputs back with updated spans
    const newUsernameSpan = document.createElement("span");
    newUsernameSpan.id = "username2";
    newUsernameSpan.textContent = data.username || newUsername;

    const newEmailSpan = document.createElement("span");
    newEmailSpan.id = "email";
    newEmailSpan.textContent = data.email || newEmail;

    usernameInput.parentNode.replaceChild(newUsernameSpan, usernameInput);
    emailInput.parentNode.replaceChild(newEmailSpan, emailInput);

    // Revert button to edit mode
    editBtn.textContent = "";
    editBtn.innerHTML = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" 
        xmlns="http://www.w3.org/2000/svg">
        <path d="M16.293 2.293L17.707 3.707L9 12.414L7.586 11L16.293 2.293ZM
                 19.707 6.707L18.293 5.293L20 3.586L21.414 5L19.707 6.707ZM
                 3 13V16H6L17.586 4.414L14.586 1.414L3 13ZM0 21H24V23H0V21Z" 
          fill="white"/>
      </svg>
    `;
    editBtn.classList.remove("save-mode");

    // Remove cancel button if exists
    const cancelBtn = editBtn.parentNode.querySelector(".cancel-btn");
    if(cancelBtn) cancelBtn.remove();

    // Remove this save listener and add edit listener back
    editBtn.removeEventListener("click", saveProfile);
    editBtn.addEventListener("click", handleEditClick);
  })
  .catch(error => {
    alert("Error updating profile: " + error.message);
  });
}

  editBtn.addEventListener("click", saveProfile, { once: true });

  </script>
</body>
</html>