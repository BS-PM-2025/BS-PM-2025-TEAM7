<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Repository Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #f6f8fa;
      color: #24292e;
      line-height: 1.5;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    h1 {
      color: #657EEF;
      margin-bottom: 20px;
    }
    
    .btn {
      background: #657EEF;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: #7a88d1;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .repo-list {
      margin-top: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .repo-item {
      padding: 20px;
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
    }
    
    .repo-actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
      padding-top: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5da;
      border-radius: 6px;
      font-family: 'Inter', sans-serif;
    }
    
    textarea.code-editor {
      min-height: 300px;
      font-family: 'Courier New', monospace;
      white-space: pre;
      overflow-x: auto;
    }
    
    .file-explorer {
      margin-top: 30px;
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      padding: 15px;
    }
    
    .file-item {
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .file-item:hover {
      background: #f6f8fa;
    }
    
    .file-item.file {
      padding-left: 30px;
    }
    
    .file-item::before {
      content: attr(data-icon);
      margin-right: 8px;
    }
    
    .file-content {
      margin-top: 20px;
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      padding: 15px;
      background: #f6f8fa;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #e1e4e8;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom: 2px solid #657EEF;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6a737d;
    }
    
    .icon {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    
    .alert.success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    
    .alert.warning {
      color: #856404;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
    }
    
    .alert.info {
      color: #0c5460;
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
    }
    
    .error-details {
      margin-top: 10px;
      font-size: 12px;
      color: #6a737d;
    }
    
    .diagnostic-section {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      background-color: #f6f8fa;
    }
    
    .diagnostic-btn {
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .diagnostic-results {
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background-color: #f1f1f1;
      border-radius: 4px;
      display: none;
    }
    
    .file-actions {
      display: flex;
      gap: 5px;
    }
    
    .file-action-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #6c757d;
      padding: 2px 5px;
      border-radius: 3px;
    }
    
    .file-action-btn:hover {
      background: #e1e4e8;
    }
    
    .breadcrumb {
      display: flex;
      flex-wrap: wrap;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      list-style: none;
      background-color: #e9ecef;
      border-radius: 0.25rem;
    }
    
    .breadcrumb-item {
      cursor: pointer;
      color: #007bff;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
      display: inline-block;
      padding-right: 0.5rem;
      padding-left: 0.5rem;
      color: #6c757d;
      content: "/";
    }
    
    .breadcrumb-item.active {
      color: #6c757d;
      cursor: default;
    }
    
    .upload-area {
      border: 2px dashed #d1d5da;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .upload-area:hover {
      border-color: #657EEF;
      background-color: #f8f9fa;
    }
    
    .upload-area.dragover {
      border-color: #657EEF;
      background-color: #f0f4ff;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #657EEF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-img {
      height: 32px;
      width: 32px;
    }
    
    .logo-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: #657EEF;
    }
    
    .nav-links {
      list-style: none;
      display: flex;
      gap: 24px;
      margin-left: auto;
    }
    
    .nav-links a {
      color: #1f2328;
      font-weight: 500;
      font-size: 14px;
      text-decoration: none;
      padding: 8px 0;
      position: relative;
    }
    
    .nav-links a:hover {
      color: #657EEF;
    }
    
    .nav-links .active {
      color: #657EEF;
    }
    
    .nav-links .active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: #657EEF;
    }
        header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 16px 10%;
      background-color: #FFFFFF;
      border-bottom: 1px solid #d8dee4;
      display: flex;
      justify-content: space-between;  /* Ensures space between logo and nav links */
      align-items: center;
      z-index: 10;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
      <header>
        <div class="logo-container">
      <svg class="logo-img" viewBox="0 0 24 24" fill="#657EEF" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.652.242 2.873.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
      </svg>
      <span class="logo-text">CI/CD</span>
          <ul class="nav-links" id="nav-links">
      <li><a href="#" >Home</a></li>
      <li><a href="/video/courses" class="active">Courses</a></li>
      <li><a href="/StudentProfile">Profile</a></li>
    </ul>
    </div>

  </header>
  <div class="container">
    <h1>GitHub Repository Management</h1>
    
    <div id="errorAlert" class="alert" style="display: none;"></div>
    <div id="successAlert" class="alert success" style="display: none;"></div>
    
    <div id="githubAuth" class="empty-state" style="display: none;">
      <div class="icon">üîí</div>
      <p>Connect your GitHub account to manage repositories</p>
      <button class="btn" id="connectGitHubBtn">Connect GitHub Account</button>
      
      <div class="diagnostic-section">
        <h3>Troubleshooting</h3>
        <p>If you're having trouble connecting, run a diagnostic check:</p>
        <button class="diagnostic-btn" id="runDiagnosticBtn">Run Diagnostic</button>
        <div id="diagnosticResults" class="diagnostic-results"></div>
      </div>
    </div>
    
    <div id="repoManagement" style="display: none;">
      <div class="tabs">
        <div class="tab active" data-tab="repos">Repositories</div>
        <div class="tab" data-tab="editor">Code Editorr</div>
      </div>
      
      <div class="tab-content active" id="repos-tab">
        <div class="form-group">
          <h2>Create New Repository</h2>
          <input type="text" id="repoName" placeholder="Repository name">
        </div>
        <div class="form-group">
          <textarea id="repoDescription" placeholder="Description"></textarea>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="repoPrivate"> Private repository
          </label>
        </div>
        <button class="btn" id="createRepoBtn">Create Repository</button>
        
        <h2 style="margin-top: 40px;">Your Repositories</h2>
        <div id="repoList" class="repo-list"></div>
      </div>
      
      <div class="tab-content" id="editor-tab">
        <div class="form-group">
          <select id="repoSelect">
            <option value="">Select a repository</option>
          </select>
        </div>
        
        <div id="fileExplorer" class="file-explorer" style="display: none;">
          <h3 id="currentRepoName"></h3>
          
          <!-- Breadcrumb navigation -->
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb" id="breadcrumbNav">
              <li class="breadcrumb-item active">Root</li>
            </ol>
          </nav>
          
          <!-- File upload area -->
          <div class="upload-area" id="uploadArea">
            <div class="icon">üì§</div>
            <p>Drag & drop files here or click to upload</p>
            <input type="file" id="fileUpload" style="display: none;">
          </div>
          
          <div id="fileTree" class="empty-state">
            <div class="icon">üìÅ</div>
            <p>Select a repository to view files</p>
          </div>
        </div>
        
        <div id="fileEditor" class="file-content" style="display: none;">
          <div class="form-group">
            <input type="text" id="filePath" placeholder="File path (e.g., src/index.js)">
          </div>
          <div class="form-group">
            <textarea id="fileContent" class="code-editor" placeholder="File content"></textarea>
          </div>
          <div class="form-group">
            <input type="text" id="commitMessage" placeholder="Commit message (e.g., Update file)">
          </div>
          <div class="form-group" style="display: flex; gap: 10px;">
            <button class="btn" id="saveFileBtn">Commit Changes</button>
            <button class="btn btn-secondary" id="newFileBtn">New File</button>
            <button class="btn btn-danger" id="deleteFileBtn" style="display: none;">Delete File</button>
          </div>
        </div>
      </div>
      
      <div class="tab-content" id="upload-tab">
        <div class="form-group">
          <h2>Upload Repository</h2>
          <p>Upload your local repository to GitHub</p>
        </div>
        <div class="form-group">
          <input type="text" id="uploadRepoName" placeholder="Repository name">
        </div>
        <div class="form-group">
          <textarea id="uploadRepoDescription" placeholder="Description"></textarea>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="uploadRepoPrivate"> Private repository
          </label>
        </div>
        <div class="form-group">
          <input type="file" id="repoZipFile" accept=".zip">
          <p class="help-text">Select a ZIP file containing your repository</p>
        </div>
        <button class="btn" id="uploadRepoBtn">Upload Repository</button>
      </div>
    </div>
  </div>
  
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // GitHub credentials will be stored in localStorage
    let githubToken = localStorage.getItem("githubToken");
    let githubUsername = localStorage.getItem("githubUsername");
    
    // Current repository and file tracking
    let currentRepo = '';
    let currentFile = null;
    let currentPath = '';
    
    document.addEventListener('DOMContentLoaded', () => {
      // Check for URL parameters that indicate OAuth status
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      const errorId = urlParams.get('id');
      const success = urlParams.get('success');
      const token = urlParams.get('token');
      const username = urlParams.get('username');
      
      // If we received GitHub credentials in the URL, save them
      if (success === 'true' && token && username) {
        localStorage.setItem("githubToken", token);
        localStorage.setItem("githubUsername", username);
        githubToken = token;
        githubUsername = username;
        
        showSuccess("GitHub account connected successfully!");
        
        // Clear the URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (error) {
        let errorMessage = getErrorMessage(error);
        if (errorId) {
          errorMessage += `<div class="error-details">Error ID: ${errorId} (Please provide this ID when reporting issues)</div>`;
        }
        showError(errorMessage, true);
        // Clear the URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
      });
      
      // Button events
      document.getElementById('connectGitHubBtn').addEventListener('click', connectGitHub);
      document.getElementById('createRepoBtn').addEventListener('click', createRepo);
      document.getElementById('saveFileBtn').addEventListener('click', saveFile);
      document.getElementById('newFileBtn').addEventListener('click', newFile);
      document.getElementById('deleteFileBtn').addEventListener('click', deleteFile);
      document.getElementById('repoSelect').addEventListener('change', loadRepoContents);
      document.getElementById('uploadRepoBtn').addEventListener('click', uploadRepository);
      document.getElementById('runDiagnosticBtn').addEventListener('click', runDiagnostic);
      
      // File upload handling
      setupFileUpload();
      
      checkGitHubConnection();
    });
    
    function setupFileUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileUpload = document.getElementById('fileUpload');
      
      // Click on upload area to trigger file input
      uploadArea.addEventListener('click', () => {
        fileUpload.click();
      });
      
      // Handle file selection
      fileUpload.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          uploadFile(e.target.files[0]);
        }
      });
      
      // Drag and drop handling
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
          uploadFile(e.dataTransfer.files[0]);
        }
      });
    }
    
    function uploadFile(file) {
      if (!currentRepo) {
        showError('Please select a repository first');
        return;
      }
      
      // Ask for file path
      const filePath = prompt(`Enter the path where you want to save "${file.name}" in the repository:`, currentPath ? `${currentPath}/${file.name}` : file.name);
      
      if (!filePath) return; // User cancelled
      
      showLoading(true);
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('path', filePath);
      formData.append('message', `Upload ${filePath}`);
      
      fetch(`/api/github/repos/${githubUsername}/${currentRepo}/upload`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${githubToken}`
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to upload file');
        return response.json();
      })
      .then(() => {
        showSuccess(`File "${filePath}" uploaded successfully!`);
        // Refresh the file tree to show the new file
        loadRepoContents();
      })
      .catch(error => {
        console.error('Error uploading file:', error);
        showError(`Failed to upload file: ${error.message}`);
      })
      .finally(() => {
        showLoading(false);
      });
    }
    
    function getErrorMessage(errorCode) {
      const errorMessages = {
        'missing_code': 'Authorization code missing. Please try connecting again.',
        'no_token': 'Failed to obtain access token from GitHub. Please try again.',
        'db_update_failed': 'Failed to update user profile with GitHub credentials.',
        'network_error': 'Network error occurred while connecting to GitHub.',
        'api_error_401': 'Authentication failed. Please check your GitHub credentials.',
        'api_error_403': 'Access forbidden. Please check your GitHub permissions.',
        'api_error_404': 'Resource not found on GitHub.',
        'api_error_422': 'GitHub could not process the request. Please try again.',
        'api_error_500': 'GitHub server error. Please try again later.',
        'invalid_state': 'Security validation failed. Please try again.',
        'github_error': 'GitHub returned an error during authorization.',
        'server_config': 'Server configuration error. Please contact support.',
        'no_user_id': 'User identification failed. Please try logging in again.',
        'unknown': 'An unknown error occurred during GitHub authentication.'
      };
      
      return errorMessages[errorCode] || 'Failed to connect to GitHub. Please try again.';
    }
    
    function showError(message, isHtml = false) {
      const errorAlert = document.getElementById('errorAlert');
      if (isHtml) {
        errorAlert.innerHTML = message;
      } else {
        errorAlert.textContent = message;
      }
      errorAlert.style.display = 'block';
      
      // Hide after 30 seconds for errors with IDs (to give time to copy the ID)
      const timeout = message.includes('Error ID') ? 30000 : 10000;
      setTimeout(() => {
        errorAlert.style.display = 'none';
      }, timeout);
    }
    
    function showSuccess(message) {
      const successAlert = document.getElementById('successAlert');
      successAlert.textContent = message;
      successAlert.style.display = 'block';
      
      // Hide after 5 seconds
      setTimeout(() => {
        successAlert.style.display = 'none';
      }, 5000);
    }
    
    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }
    
    function runDiagnostic() {
      const diagnosticBtn = document.getElementById('runDiagnosticBtn');
      const diagnosticResults = document.getElementById('diagnosticResults');
      
      diagnosticBtn.disabled = true;
      diagnosticBtn.textContent = 'Running...';
      diagnosticResults.textContent = 'Running diagnostic checks...';
      diagnosticResults.style.display = 'block';
      
      fetch('/api/github/diagnostic')
        .then(response => {
          if (!response.ok) throw new Error('Failed to run diagnostic');
          return response.json();
        })
        .then(results => {
          diagnosticResults.textContent = JSON.stringify(results, null, 2);
          
          // Analyze results and provide recommendations
          let recommendations = '\n\n--- RECOMMENDATIONS ---\n';
          
          // Check environment variables
          if (!results.environment.clientIdSet || !results.environment.clientSecretSet || !results.environment.redirectUriSet) {
            recommendations += '‚Ä¢ Server is missing required GitHub OAuth environment variables. Contact administrator.\n';
          }
          
          // Check GitHub API connectivity
          if (results.connectivity.github && results.connectivity.github.status === 'success') {
            recommendations += '‚Ä¢ GitHub API connection is working correctly.\n';
          } else {
            recommendations += '‚Ä¢ GitHub API connection failed. Check network connectivity or firewall settings.\n';
          }
          
          // Add recommendations to results
          diagnosticResults.textContent += recommendations;
        })
        .catch(error => {
          console.error('Diagnostic error:', error);
          diagnosticResults.textContent = 'Error running diagnostic: ' + error.message;
        })
        .finally(() => {
          diagnosticBtn.disabled = false;
          diagnosticBtn.textContent = 'Run Diagnostic';
        });
    }
    
    function checkGitHubConnection() {
      if (githubToken && githubUsername) {
        // We have GitHub credentials, verify they're valid
        fetch('/api/github/connection-status', {
          headers: {
            Authorization: `Bearer ${githubToken}`
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('Failed to check connection status');
          return response.json();
        })
        .then(data => {
          if (data.connected) {
            document.getElementById('githubAuth').style.display = 'none';
            document.getElementById('repoManagement').style.display = 'block';
            fetchRepositories();
          } else if (data.error === 'token_invalid') {
            // Token is invalid, clear it
            localStorage.removeItem("githubToken");
            localStorage.removeItem("githubUsername");
            githubToken = null;
            githubUsername = null;
            
            showError('Your GitHub token has expired or is invalid. Please reconnect your account.');
            document.getElementById('githubAuth').style.display = 'block';
            document.getElementById('repoManagement').style.display = 'none';
          } else {
            document.getElementById('githubAuth').style.display = 'block';
            document.getElementById('repoManagement').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error checking GitHub connection:', error);
          document.getElementById('githubAuth').style.display = 'block';
          document.getElementById('repoManagement').style.display = 'none';
        });
      } else {
        // No GitHub credentials, show auth screen
        document.getElementById('githubAuth').style.display = 'block';
        document.getElementById('repoManagement').style.display = 'none';
      }
    }
    
    function connectGitHub() {
      window.location.href = '/api/github/login';
    }
    
    function fetchRepositories() {
      showLoading(true);
      
      fetch('/api/github/repos', {
        headers: {
          Authorization: `Bearer ${githubToken}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to fetch repositories');
        return response.json();
      })
      .then(repos => {
        const repoList = document.getElementById('repoList');
        const repoSelect = document.getElementById('repoSelect');
        
        repoList.innerHTML = '';
        repoSelect.innerHTML = '<option value="">Select a repository</option>';
        
        if (!repos || repos.length === 0) {
          repoList.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìÇ</div>
              <p>No repositories found. Create your first one!</p>
            </div>
          `;
          showLoading(false);
          return;
        }
        
        repos.forEach(repo => {
          // Add to repository list
          const repoDiv = document.createElement('div');
          repoDiv.className = 'repo-item';
          repoDiv.innerHTML = `
            <h3>${repo.name} ${repo.private ? 'üîí' : 'üåç'}</h3>
            <p>${repo.description || 'No description'}</p>
            <div class="repo-actions">
              <button class="btn" onclick="loadRepoForEditor('${repo.name}')">Edit Files</button>
              <a href="${repo.html_url}" target="_blank" class="btn btn-secondary">View on GitHub</a>
            </div>
          `;
          repoList.appendChild(repoDiv);
          
          // Add to repository select dropdown
          const option = document.createElement('option');
          option.value = repo.name;
          option.textContent = repo.name;
          repoSelect.appendChild(option);
        });
        
        showLoading(false);
      })
      .catch(error => {
        console.error('Error fetching repositories:', error);
        document.getElementById('repoList').innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ö†Ô∏è</div>
            <p>Failed to load repositories. Please try again.</p>
          </div>
        `;
        showError('Failed to fetch repositories. This could be due to an expired GitHub token. Try reconnecting your GitHub account.');
        showLoading(false);
      });
    }
    
    function createRepo() {
      const name = document.getElementById('repoName').value;
      const description = document.getElementById('repoDescription').value;
      const isPrivate = document.getElementById('repoPrivate').checked;
      
      if (!name) {
        showError('Please enter a repository name');
        return;
      }
      
      const btn = document.getElementById('createRepoBtn');
      btn.disabled = true;
      btn.textContent = 'Creating...';
      showLoading(true);
      
      // Define initial folder structure and files
      const initialFiles = [
        {
          path: 'src/index.js',
          content: '// Your code here\nconsole.log("Hello from your new repository!");',
          message: 'Add initial index.js file'
        },
        {
          path: 'README.md',
          content: `# ${name}\n\n${description || 'A new GitHub repository'}`,
          message: 'Add README.md'
        }
      ];
      
      fetch('/api/github/repos', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${githubToken}`
        },
        body: JSON.stringify({
          name,
          description,
          isPrivate,
          initialFiles
        })
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to create repository');
        return response.json();
      })
      .then(() => {
        showSuccess('Repository created successfully with initial files!');
        fetchRepositories();
        document.getElementById('repoName').value = '';
        document.getElementById('repoDescription').value = '';
        document.getElementById('repoPrivate').checked = false;
      })
      .catch(error => {
        console.error('Error creating repository:', error);
        showError('Failed to create repository: ' + error.message);
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Create Repository';
        showLoading(false);
      });
    }
    
    function loadRepoForEditor(repoName) {
      currentRepo = repoName;
      document.getElementById('editor-tab').classList.add('active');
      document.getElementById('repos-tab').classList.remove('active');
      document.getElementById('upload-tab').classList.remove('active');
      document.querySelector('.tab[data-tab="editor"]').classList.add('active');
      document.querySelector('.tab[data-tab="repos"]').classList.remove('active');
      document.querySelector('.tab[data-tab="upload"]').classList.remove('active');
      document.getElementById('repoSelect').value = repoName;
      loadRepoContents();
    }
    
    function loadRepoContents() {
      const repoName = document.getElementById('repoSelect').value;
      if (!repoName) {
        document.getElementById('fileExplorer').style.display = 'none';
        document.getElementById('fileEditor').style.display = 'none';
        document.getElementById('fileTree').innerHTML = `
          <div class="empty-state">
            <div class="icon">üìÅ</div>
            <p>Select a repository to view files</p>
          </div>
        `;
        return;
      }
      
      currentRepo = repoName;
      currentPath = ''; // Reset to root when changing repos
      document.getElementById('currentRepoName').textContent = repoName;
      updateBreadcrumb();
      
      showLoading(true);
      
      fetch(`/api/github/repos/${githubUsername}/${repoName}/contents`, {
        headers: {
          Authorization: `Bearer ${githubToken}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to load repository contents');
        return response.json();
      })
      .then(contents => {
        renderFileTree(contents);
        document.getElementById('fileExplorer').style.display = 'block';
        document.getElementById('fileEditor').style.display = 'none';
        showLoading(false);
      })
      .catch(error => {
        console.error('Error loading repository contents:', error);
        document.getElementById('fileTree').innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ö†Ô∏è</div>
            <p>Failed to load repository contents</p>
          </div>
        `;
        showError('Failed to load repository contents: ' + error.message);
        showLoading(false);
      });
    }
    
    function updateBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumbNav');
      breadcrumb.innerHTML = '';
      
      // Add root item
      const rootItem = document.createElement('li');
      rootItem.className = 'breadcrumb-item';
      rootItem.textContent = 'Root';
      rootItem.onclick = () => {
        currentPath = '';
        updateBreadcrumb();
        loadRepoContents();
      };
      
      if (currentPath === '') {
        rootItem.className += ' active';
        rootItem.onclick = null;
      }
      
      breadcrumb.appendChild(rootItem);
      
      // Add path segments
      if (currentPath) {
        const segments = currentPath.split('/');
        let currentSegmentPath = '';
        
        segments.forEach((segment, index) => {
          currentSegmentPath += (index > 0 ? '/' : '') + segment;
          
          const item = document.createElement('li');
          item.className = 'breadcrumb-item';
          item.textContent = segment;
          
          if (index === segments.length - 1) {
            item.className += ' active';
          } else {
            const path = currentSegmentPath;
            item.onclick = () => {
              currentPath = path;
              updateBreadcrumb();
              
              fetch(`/api/github/repos/${githubUsername}/${currentRepo}/contents?path=${currentPath}`, {
                headers: {
                  Authorization: `Bearer ${githubToken}`
                }
              })
              .then(response => {
                if (!response.ok) throw new Error('Failed to load directory');
                return response.json();
              })
              .then(contents => renderFileTree(contents))
              .catch(error => {
                console.error('Error loading directory:', error);
                showError('Failed to load directory: ' + error.message);
              });
            };
          }
          
          breadcrumb.appendChild(item);
        });
      }
    }
    
    function renderFileTree(contents) {
      const fileTree = document.getElementById('fileTree');
      
      if (!contents || contents.length === 0) {
        fileTree.innerHTML = `
          <div class="empty-state">
            <div class="icon">üìÅ</div>
            <p>This directory is empty</p>
          </div>
        `;
        return;
      }
      
      fileTree.innerHTML = '';
      
      // Sort directories first, then files
      contents.sort((a, b) => {
        if (a.type === b.type) return a.name.localeCompare(b.name);
        return a.type === 'dir' ? -1 : 1;
      });
      
      contents.forEach(item => {
        const fileItem = document.createElement('div');
        fileItem.className = `file-item ${item.type === 'file' ? 'file' : 'dir'}`;
        fileItem.dataset.icon = item.type === 'dir' ? 'üìÅ' : 'üìÑ';
        
        const itemContent = document.createElement('span');
        itemContent.textContent = item.name;
        fileItem.appendChild(itemContent);
        
        // Add file actions for files
        if (item.type === 'file') {
          const actions = document.createElement('div');
          actions.className = 'file-actions';
          
          // Edit button
          const editBtn = document.createElement('button');
          editBtn.className = 'file-action-btn';
          editBtn.innerHTML = '‚úèÔ∏è';
          editBtn.title = 'Edit';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            loadFileContent(item);
          };
          actions.appendChild(editBtn);
          
          // Delete button
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'file-action-btn';
          deleteBtn.innerHTML = 'üóëÔ∏è';
          deleteBtn.title = 'Delete';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`Are you sure you want to delete ${item.name}?`)) {
              deleteFileFromRepo(item);
            }
          };
          actions.appendChild(deleteBtn);
          
          fileItem.appendChild(actions);
        }
        
        fileItem.onclick = () => {
          if (item.type === 'dir') {
            currentPath = item.path;
            updateBreadcrumb();
            
            showLoading(true);
            fetch(`/api/github/repos/${githubUsername}/${currentRepo}/contents?path=${item.path}`, {
              headers: {
                Authorization: `Bearer ${githubToken}`
              }
            })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load directory');
              return response.json();
            })
            .then(contents => {
              renderFileTree(contents);
              showLoading(false);
            })
            .catch(error => {
              console.error('Error loading directory:', error);
              showError('Failed to load directory: ' + error.message);
              showLoading(false);
            });
          } else {
            loadFileContent(item);
          }
        };
        fileTree.appendChild(fileItem);
      });
    }
    
    function loadFileContent(file) {
      currentFile = file;
      document.getElementById('filePath').value = file.path;
      document.getElementById('commitMessage').value = `Update ${file.name}`;
      document.getElementById('deleteFileBtn').style.display = 'block';
      
      showLoading(true);
      
      fetch(file.download_url)
        .then(response => {
          if (!response.ok) throw new Error('Failed to load file content');
          return response.text();
        })
        .then(content => {
          document.getElementById('fileContent').value = content;
          document.getElementById('fileEditor').style.display = 'block';
          showLoading(false);
        })
        .catch(error => {
          console.error('Error loading file content:', error);
          showError('Failed to load file content: ' + error.message);
          showLoading(false);
        });
    }
    
     function saveFile() {
    const path = document.getElementById('filePath').value;
    const content = document.getElementById('fileContent').value;
    const message = document.getElementById('commitMessage').value;
    
    if (!path || !content || !message) {
      showError('Please fill in all fields');
      return;
    }
    
    const btn = document.getElementById('saveFileBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    showLoading(true);
    
    // If editing an existing file, include the SHA
    const sha = currentFile ? currentFile.sha : null;
    
    // Use the generic POST endpoint for all file paths to avoid routing issues
    fetch(`/api/github/repos/${githubUsername}/${currentRepo}/update-file`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${githubToken}`
      },
      body: JSON.stringify({
        path,
        content,
        message,
        sha
      })
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to save file');
      return response.json();
    })
    .then(() => {
      showSuccess('File saved successfully!');
      
      // If we're in a directory, refresh that directory
      if (currentPath) {
        fetch(`/api/github/repos/${githubUsername}/${currentRepo}/contents?path=${currentPath}`, {
          headers: {
            Authorization: `Bearer ${githubToken}`
          }
        })
        .then(response => response.json())
        .then(contents => renderFileTree(contents))
        .catch(error => console.error('Error refreshing directory:', error));
      } else {
        // Otherwise refresh the root
        loadRepoContents();
      }
    })
    .catch(error => {
      console.error('Error saving file:', error);
      showError('Failed to save file: ' + error.message);
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = 'Commit Changes';
      showLoading(false);
    });
  }
    
    function newFile() {
      currentFile = null;
      document.getElementById('filePath').value = currentPath ? `${currentPath}/new-file.txt` : 'new-file.txt';
      document.getElementById('fileContent').value = '';
      document.getElementById('commitMessage').value = 'Add new file';
      document.getElementById('fileEditor').style.display = 'block';
      document.getElementById('deleteFileBtn').style.display = 'none';
    }
    
    function deleteFile() {
      if (!currentFile) {
        showError('No file selected for deletion');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${currentFile.name}?`)) {
        return;
      }
      
      deleteFileFromRepo(currentFile);
    }
    
      function deleteFileFromRepo(file) {
    showLoading(true);
    
    fetch(`/api/github/repos/${githubUsername}/${currentRepo}/delete-file`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${githubToken}`
      },
      body: JSON.stringify({
        path: file.path,
        message: `Delete ${file.name}`,
        sha: file.sha
      })
    })
    .then(response => {
      if (!response.ok) throw new Error('Failed to delete file');
      return response.json();
    })
    .then(() => {
      showSuccess(`File ${file.name} deleted successfully!`);
      
      // If we were editing this file, close the editor
      if (currentFile && currentFile.path === file.path) {
        document.getElementById('fileEditor').style.display = 'none';
        currentFile = null;
      }
      
      // Refresh the file tree
      if (currentPath) {
        fetch(`/api/github/repos/${githubUsername}/${currentRepo}/contents?path=${currentPath}`, {
          headers: {
            Authorization: `Bearer ${githubToken}`
          }
        })
        .then(response => response.json())
        .then(contents => renderFileTree(contents))
        .catch(error => console.error('Error refreshing directory:', error));
      } else {
        loadRepoContents();
      }
    })
    .catch(error => {
      console.error('Error deleting file:', error);
      showError('Failed to delete file: ' + error.message);
    })
    .finally(() => {
      showLoading(false);
    });
  }
  
    
    function uploadRepository() {
      const name = document.getElementById('uploadRepoName').value;
      const description = document.getElementById('uploadRepoDescription').value;
      const isPrivate = document.getElementById('uploadRepoPrivate').checked;
      const fileInput = document.getElementById('repoZipFile');
      
      if (!name || !fileInput.files.length) {
        showError('Please enter a repository name and select a ZIP file');
        return;
      }
      
      const btn = document.getElementById('uploadRepoBtn');
      btn.disabled = true;
      btn.textContent = 'Uploading...';
      showLoading(true);
      
      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description);
      formData.append('isPrivate', isPrivate);
      formData.append('zipFile', fileInput.files[0]);
      
      fetch('/api/github/upload-repo', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${githubToken}`
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) throw new Error('Failed to upload repository');
        return response.json();
      })
      .then(() => {
        showSuccess('Repository uploaded successfully!');
        fetchRepositories();
        document.getElementById('uploadRepoName').value = '';
        document.getElementById('uploadRepoDescription').value = '';
        document.getElementById('uploadRepoPrivate').checked = false;
        fileInput.value = '';
      })
      .catch(error => {
        console.error('Error uploading repository:', error);
        showError('Failed to upload repository: ' + error.message);
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Upload Repository';
        showLoading(false);
      });
    }
  </script>
</body>
</html>
