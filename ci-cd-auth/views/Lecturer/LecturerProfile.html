<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lecturer Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f6f8fa;
      color: #1f2328;
      line-height: 1.5;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 16px 10%;
      background-color: #ffffff;
      border-bottom: 1px solid #d8dee4;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-img {
      height: 32px;
      width: 32px;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: #8b9aeb;
    }

    .nav-links {
      list-style: none;
      display: flex;
      gap: 24px;
    }

    .nav-links li a {
      text-decoration: none;
      color: #1f2328;
      font-weight: 500;
      font-size: 14px;
      padding: 8px 0;
      position: relative;
    }

    .nav-links li a:hover {
      color: #8b9aeb;
    }

    .nav-links li a.active {
      color: #8b9aeb;
    }

    .nav-links li a.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #8b9aeb;
    }

    .page-container {
      display: flex;
      padding-top: 80px;
      min-height: calc(100vh - 80px);
      gap: 20px;
      padding: 80px 20px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 20px;
    }

    /* Profile Card Styles */
    .profile-card {
      background-color: #8b9aeb;
      border-radius: 16px;
      padding: 30px;
      color: white;
      width: 100%;
      position: relative;
      box-shadow: 0 4px 12px rgba(91, 118, 247, 0.2);
    }

    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .profile-title {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .profile-info {
      margin-bottom: 10px;
    }

    .profile-info p {
      margin-bottom: 5px;
      font-size: 16px;
    }

    .edit-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      color: white;
      font-size: 20px;
    }

    .avatar-container {
      display: flex;
      align-items: center;
      margin-top: 20px;
    }

    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background-color: #e99f6b;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 20px;
      position: relative;
    }

    .avatar-decoration {
      position: absolute;
      bottom: -10px;
      width: 100%;
      height: 20px;
      background-color: #4cceac;
      border-radius: 10px;
      z-index: -1;
    }

    .level-container {
      display: flex;
      flex-direction: column;
    }

    .level-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .level-value {
      color: #4cceac;
      font-weight: 600;
    }

    .learn-more {
      color: white;
      font-size: 14px;
      text-decoration: none;
      opacity: 0.8;
    }

    .learn-more:hover {
      opacity: 1;
      text-decoration: underline;
    }

    /* Content Card */
    .content-card {
      background-color: white;
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .content-title {
      font-size: 24px;
      font-weight: 600;
      color: #8b9aeb;
      margin-bottom: 20px;
    }

    .content-text {
      color: #333;
      margin-bottom: 20px;
    }

    .start-button {
      display: inline-block;
      background-color: #8b9aeb;
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .start-button:hover {
      background-color: #4a65e6;
    }

    /* Game Categories Card */
    .stats-card {
      background-color: white;
      border-radius: 16px;
      padding: 30px;
      width: 100%;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .completion-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
      width: 100%;
    }

    .progress-circle {
      position: relative;
      width: 150px;
      height: 150px;
      margin-bottom: 20px;
    }

    .progress-circle svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .progress-circle-bg {
      fill: none;
      stroke: #f0f0f0;
      stroke-width: 12;
    }

    .progress-circle-fill {
      fill: none;
      stroke: #4cceac;
      stroke-width: 12;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: calc(283 - (283 * var(--progress-percent)) / 100);
      transition: stroke-dashoffset 0.5s ease-out;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .progress-percentage {
      font-size: 24px;
      font-weight: 600;
      color: #8b9aeb;
    }

    .progress-label {
      font-size: 14px;
      color: #666;
    }

    .categories-title {
      font-size: 20px;
      font-weight: 600;
      color: #8b9aeb;
      margin-bottom: 20px;
      text-align: center;
      width: 100%;
    }

    .category-list {
      width: 100%;
    }

    .category-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
      width: 100%;
    }

    .category-info {
      flex: 1;
    }

    .category-name {
      font-size: 16px;
      font-weight: 500;
      color: #8b9aeb;
      margin-bottom: 5px;
    }

    .category-progress {
      width: 100%;
      height: 6px;
      background-color: #f0f0f0;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }

    .category-progress-fill {
      height: 100%;
      background-color: #4cceac;
      border-radius: 3px;
    }

    .category-activity {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    .category-arrow {
      color: #8b9aeb;
      font-size: 20px;
      margin-left: 10px;
    }

    .view-all-link {
      display: block;
      text-align: right;
      color: #8b9aeb;
      font-size: 14px;
      text-decoration: none;
      margin-top: 10px;
      width: 100%;
    }

    .view-all-link:hover {
      text-decoration: underline;
    }

    /* Students List */
    .students-section {
      padding: 20px;
      border-top: 1px solid #ddd;
    }

    .students-section h2 {
      font-size: 24px;
      color: #8b9aeb;
      margin-bottom: 20px;
    }

    .students-list {
      list-style: none;
      padding: 0;
    }

    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      background-color: #f9f9f9;
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    .student-item:hover {
      background-color: #f0f0f0;
    }

    .student-info {
      flex: 1;
    }

    .student-name {
      font-weight: 500;
      color: #333;
    }

    .student-email {
      font-size: 13px;
      color: #666;
    }

    .feedback-btn {
      background-color: #8b9aeb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .feedback-btn:hover {
      background-color: #7a89da;
    }

    .view-feedback-btn {
      background-color: #4cceac;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-left: 8px;
    }

    .view-feedback-btn:hover {
      background-color: #3dbd9b;
    }
        /* Avatar image inherits the circle */
    .avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}

    /* ── full-screen viewer ─────────────────────────────── */
    .full-photo-modal{display:none;position:fixed;inset:0;z-index:1300;
      background:rgba(0,0,0,.8);justify-content:center;align-items:center;}
    .full-photo-modal.show{display:flex;}

    .full-photo-modal img{max-width:80vw;max-height:80vh;border-radius:8px;
      box-shadow:0 12px 40px rgba(0,0,0,.35);}

    .full-photo-close{position:absolute;top:30px;right:40px;font-size:46px;
      color:#fff;font-weight:bold;cursor:pointer;line-height:1;}
    .full-photo-close:hover{transform:rotate(90deg);}

    /* Feedback Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .feedback-modal {
      background-color: white;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .feedback-modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 600;
      color: #8b9aeb;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .feedback-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-weight: 500;
      color: #555;
    }

    .feedback-textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      min-height: 120px;
      resize: vertical;
      font-family: 'Inter', sans-serif;
    }

    .feedback-textarea:focus {
      outline: none;
      border-color: #8b9aeb;
    }

    .rating-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 10px 0;
    }

    .star {
      font-size: 28px;
      color: #ddd;
      cursor: pointer;
      transition: color 0.2s;
    }

    .star.active {
      color: #ffc107;
    }

    .submit-btn {
      background-color: #8b9aeb;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .submit-btn:hover {
      background-color: #7a89da;
    }

    /* Success Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background-color: #4cceac;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .toast.visible {
      opacity: 1;
      visibility: visible;
    }

    .toast-icon {
      font-size: 20px;
    }

    /* Feedback List Modal */
    .feedback-list-modal {
      background-color: white;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      max-height: 80vh;
      overflow-y: auto;
    }

    .feedback-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .feedback-item:last-child {
      border-bottom: none;
    }

    .feedback-message {
      margin-bottom: 8px;
      color: #333;
    }

    .feedback-rating {
      display: flex;
      align-items: center;
      color: #666;
      font-size: 14px;
    }

    .feedback-date {
      color: #999;
      font-size: 12px;
      margin-top: 5px;
      text-align: right;
    }

    .feedback-stars {
      color: #ffc107;
      margin-left: 5px;
    }

    .no-feedback {
      color: #666;
      text-align: center;
      padding: 20px;
    }

    .student-feedback-list {
      list-style: none;
      padding-left: 16px;
      margin-top: 8px;
      border-left: 2px solid #ddd;
    }
    
    .student-feedback-list li {
      margin-bottom: 8px;
      padding-left: 8px;
      position: relative;
    }
    
    .student-feedback-list li::before {
      content: "•";
      color: #8b9aeb;
      font-weight: bold;
      position: absolute;
      left: -5px;
    }
    
    .feedback-rating-stars {
      color: #ffc107;
      margin-left: 5px;
    }
    /* === Avatar-photo buttons so we can see the photo  ========================================== */
    .photo-btn-row{
      display:flex;
      gap:10px;
      margin-top:14px;
    } 

    .photo-btn{
      border:none;
      border-radius:8px;
      padding:8px 16px;
      font:600 14px/1 'Inter',sans-serif;
      cursor:pointer;
      transition:background .2s, transform .2s;
      display:flex;
      align-items:center;
      gap:6px;
    }
        /* ─── avatar-photo modal (shared) ─────────────────────── */
    .photo-modal           {display:none;position:fixed;inset:0;
                            background:rgba(0,0,0,.55);justify-content:center;align-items:center;z-index:1200;}
    .photo-modal.show      {display:flex;}

    .photo-modal-box       {background:#fff;border-radius:18px;padding:36px 40px;
                            width:95%;max-width:420px;box-shadow:0 18px 40px rgba(0,0,0,.25);
                            animation:pop .3s ease;}
    @keyframes pop{from{transform:scale(.9);opacity:0;}to{transform:scale(1);opacity:1;}}

    .modal-close           {position:absolute;top:18px;right:24px;font-size:32px;line-height:1;
                            background:none;border:none;color:#aaa;cursor:pointer;transition:.2s;}
    .modal-close:hover     {color:#000;transform:rotate(90deg);}

    .modal-title           {font-size:22px;font-weight:600;color:#657EEF;text-align:center;margin-bottom:28px;}

    .drop-zone             {border:2px dashed #657EEF99;border-radius:15px;display:flex;flex-direction:column;
                            align-items:center;justify-content:center;height:220px;cursor:pointer;}
    .drop-zone:hover       {background:#f8f9ff;}
    .dz-icon               {font-size:48px;color:#8b9aeb;margin-bottom:16px;}
    .dz-text               {text-align:center;color:#555;} .dz-text span{color:#888;font-style:italic;}

    .upload-btn            {width:100%;margin-top:30px;padding:14px;background:#657EEF;color:#fff;
                            border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;}
    .upload-btn:hover      {background:#4a65e6;transform:translateY(-2px);}

    /* Upload = brand blue */
    .upload-photo{
      background:#657EEF;
      color:#fff;
    }
    .upload-photo:hover{ background:#4a65e6; transform:translateY(-2px); }

    /* Delete = alert red */
    .delete-photo{
      background:#ff4c4c;
      color:#fff;
    }
    .delete-photo:hover{ background:#d92727; transform:translateY(-2px); }


    @media (max-width: 1024px) {
      .page-container {
        flex-direction: column;
      }
      
      .stats-card {
        max-width: 100%;
        margin-top: 20px;
        order: 3;
      }
    }

    @media (max-width: 768px) {
      .page-container {
        padding: 80px 15px 20px;
      }
      
      .profile-header {
        flex-direction: column;
      }
      
      .avatar-container {
        margin-top: 20px;
      }

      .feedback-modal {
        width: 90%;
        padding: 20px;
      }
      
      .student-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .feedback-btn, .view-feedback-btn {
        margin-top: 10px;
        margin-left: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <svg class="logo-img" viewBox="0 0 24 24" fill="#8b9aeb" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.652.242 2.873.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
      </svg>
      <span class="logo-text">CI/CD</span>
      <ul class="nav-links" id="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
        <li><a href="http://localhost:3000/exam-management">exam</a></li>
      </ul>
    </div>
  </header>
<!-- Big-photo overlay -->
<div id="lecViewModal" class="full-photo-modal">
  <span class="full-photo-close" id="lecCloseView">×</span>
  <img id="lecFullImg" src="" alt="Profile photo">
</div>

  <div class="page-container">
    <!-- Main Content (Left) -->
    <div class="main-content">
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-header">
          <h1 class="profile-title">Welcome, <span id="username">Lecturer</span></h1>
          <button class="edit-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16.293 2.293L17.707 3.707L9 12.414L7.586 11L16.293 2.293ZM19.707 6.707L18.293 5.293L20 3.586L21.414 5L19.707 6.707ZM3 13V16H6L17.586 4.414L14.586 1.414L3 13ZM0 21H24V23H0V21Z" fill="white"/>
            </svg>
          </button>
        </div>
       
        <div class="profile-info">
          <p><strong>Username:</strong> <span id="username2"></span></p>
          <p><strong>Email:</strong> <span id="email"></span></p>
          <p><strong>Role:</strong> <span id="role">Lecturer</span></p>
        </div>
        
        <div class="avatar-container">
          <div class="avatar">
            <div style="color: white; font-size: 24px; font-weight: bold;" id="avatarInitials"></div>
            <div class="avatar-decoration"></div>
          </div>
          
          <div class="level-container">
            <div class="level-title">Status: <span class="level-value">Active</span></div>
            <a href="#" class="learn-more">Account settings</a>
          </div>
        </div>
        <div class="photo-btn-row">
          <button id="uploadPhotoLink"  class="photo-btn upload-photo"  title="Upload a new picture">📤 Upload</button>
          <button id="deletePhotoLink"  class="photo-btn delete-photo"  title="Remove current picture">🗑️ Delete</button>
        </div>

      </div>

      
      <!-- Students List Card -->
      <div class="content-card">
        <section class="students-section">
          <h2>Your Students</h2>
          <ul class="students-list" id="studentsList"></ul>
        </section>
      </div>
    </div>
    
    <!-- Game Categories Card (Right) -->
    <div class="stats-card">
      <div class="completion-container">
        <div class="progress-circle">
          <svg viewBox="0 0 100 100">
            <circle class="progress-circle-bg" cx="50" cy="50" r="45"></circle>
            <circle class="progress-circle-fill" cx="50" cy="50" r="45" style="--progress-percent: 70;"></circle>
          </svg>
          <div class="progress-text">
            <div class="progress-percentage">70%</div>
            <div class="progress-label">Engagement</div>
          </div>
        </div>
      </div>
      
      <h2 class="categories-title">Game Categories</h2>
      
      <div class="category-list">
        <div class="category-item">
          <div class="category-info">
            <div class="category-name">CI/CD Basics Match</div>
            <div class="category-progress">
              <div class="category-progress-fill" style="width: 70%;"></div>
            </div>
            <div class="category-activity">Last activity: 3 days ago</div>
          </div>
          <div class="category-arrow">▶</div>
        </div>
        
        <div class="category-item">
          <div class="category-info">
            <div class="category-name">DevOps Match Up</div>
            <div class="category-progress">
              <div class="category-progress-fill" style="width: 45%;"></div>
            </div>
            <div class="category-activity">Last activity: 8 days ago</div>
          </div>
          <div class="category-arrow">▶</div>
        </div>
        
        <a href="#" class="view-all-link">View all</a>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal-overlay" id="feedbackModal">
    <div class="feedback-modal">
      <div class="modal-header">
        <h3 class="modal-title">Give Feedback</h3>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <form class="feedback-form" id="feedbackForm">
        <input type="hidden" id="studentIdInput">
        <div class="form-group">
          <label class="form-label">Feedback Message</label>
          <textarea class="feedback-textarea" id="feedbackMessage" placeholder="Write your feedback here..." required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Rating</label>
          <div class="rating-container" id="ratingStars">
            <i class="fas fa-star star" data-rating="1"></i>
            <i class="fas fa-star star" data-rating="2"></i>
            <i class="fas fa-star star" data-rating="3"></i>
            <i class="fas fa-star star" data-rating="4"></i>
            <i class="fas fa-star star" data-rating="5"></i>
          </div>
          <input type="hidden" id="ratingInput" required>
        </div>
        <button type="submit" class="submit-btn">Submit Feedback</button>
      </form>
    </div>
  </div>

  <!-- Feedback List Modal -->
  <div class="modal-overlay" id="feedbackListModal">
    <div class="feedback-list-modal">
      <div class="modal-header">
        <h3 class="modal-title" id="feedbackListTitle">Feedback for Student</h3>
        <button class="close-btn" id="closeFeedbackListModal">&times;</button>
      </div>
      <div id="feedbackListContent">
        <!-- Feedback items will be inserted here -->
      </div>
    </div>
  </div>
<!-- Lecturer – Profile-photo modal -->
<div id="lecPhotoModal" class="photo-modal">
  <div class="photo-modal-box">
    <button class="modal-close" id="lecClosePhoto">×</button>

    <h2 class="modal-title">Upload Profile Photo</h2>

    <!-- DROP ZONE -->
    <input id="lecPhotoInput" type="file" accept="image/*" hidden>
    <label for="lecPhotoInput"  class="drop-zone" id="lecDropZone">
      <i class="fas fa-camera-retro dz-icon"></i>
      <p class="dz-text">
        Drag an image here<br>
        <span>or click to browse</span>
      </p>
    </label>

    <button class="upload-btn" id="lecUploadBtn">🚀 Upload</button>
  </div>
</div>

  <!-- Success Toast -->
  <div class="toast" id="successToast">
    <i class="fas fa-check-circle toast-icon"></i>
    <span>Feedback submitted successfully!</span>
  </div>

  <script>
    (() => {          

  /* ===== basic helpers ===== */
  const token   = sessionStorage.getItem("token");
  const user    = token ? JSON.parse(atob(token.split('.')[1])) : null;
  if (!user) return;                               // not logged-in

  const key     = `profilePhoto_${user.id}`;       // localStorage key
  const avatar  = document.getElementById('avatarInitials').parentElement;

  /* ===== element refs ===== */
  const modal   = document.getElementById('lecPhotoModal');
  const dz      = document.getElementById('lecDropZone');
  const input   = document.getElementById('lecPhotoInput');
  const upload  = document.getElementById('lecUploadBtn');
  const close   = document.getElementById('lecClosePhoto');
  const openBtn = document.getElementById('uploadPhotoLink');
  const delBtn  = document.getElementById('deletePhotoLink');
  const viewModal = document.getElementById('lecViewModal');   
  const fullImg   = document.getElementById('lecFullImg');     
  const closeView = document.getElementById('lecCloseView');  
   avatar.style.cursor = 'pointer';                            
  avatar.onclick = () => {                                     
     const src = localStorage.getItem(key);
     if (!src) return;            // nothing to show yet
     fullImg.src = src;
     viewModal.classList.add('show');
  };

  closeView.onclick = () => viewModal.classList.remove('show'); 
  viewModal.onclick = e => {                                   
     if (e.target === viewModal) closeView.onclick();
  };
  /* ===== open / close ===== */
  openBtn.onclick  = () => modal.classList.add('show');
  close.onclick    = () => modal.classList.remove('show');
  modal.onclick    = e => { if (e.target === modal) close.onclick(); };

  /* ===== drag-and-drop ===== */
  ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, e => {
      e.preventDefault(); dz.style.background = '#eef2ff';
  }));
  ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, e => {
      e.preventDefault(); dz.style.background = '';
  }));
  dz.addEventListener('drop', e => { input.files = e.dataTransfer.files; });

  /* ===== upload ===== */
  const render = src => {
     avatar.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover;">`;
  };

  // load saved photo on page-load
  const saved = localStorage.getItem(key);
  if (saved) render(saved);

  upload.onclick = () => {
      const file = input.files[0];
      if (!file) return alert('Choose an image first 😊');

      const reader = new FileReader();
      reader.onload = e => {
         localStorage.setItem(key, e.target.result);
         render(e.target.result);
         modal.classList.remove('show');
      };
      reader.readAsDataURL(file);
  };

  /* ===== delete ===== */
  delBtn.onclick = () => {
      localStorage.removeItem(key);
      avatar.innerHTML = `<div class="avatar-initials">${avatar.dataset.initials}</div>
                          <div class="avatar-decoration"></div>`;
  };

})();            // end IIFE
    function goHome() {
      window.location.href = "/";
    }

    function logout() {
      sessionStorage.removeItem("token");
      window.location.href = "/login";
    }

    function parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch {
        return null;
      }
    }

    function getInitials(name) {
      if (!name) return 'L';
      const parts = name.split(' ');
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function renderStars(rating) {
      let stars = '';
      for (let i = 0; i < 5; i++) {
        if (i < rating) {
          stars += '<i class="fas fa-star feedback-rating-stars"></i>';
        } else {
          stars += '<i class="far fa-star feedback-rating-stars"></i>';
        }
      }
      return stars;
    }

    // Check if token exists in session storage
    const token = sessionStorage.getItem("token");
    
    // If token exists, parse it and update user info
    if (token) {
      const user = parseJwt(token);
      
      if (user && user.role === "lecturer") {
        document.getElementById("username").textContent = user.username || "Lecturer";
        document.getElementById("username2").textContent = user.username || "Lecturer";
        document.getElementById("email").textContent = user.email || "Not provided";
        document.getElementById("avatarInitials").textContent = getInitials(user.username);
      } else {
        alert("Access denied. Please log in as a lecturer.");
        window.location.href = "/login";
      }
    } else {
      window.location.href = "/login";
    }

    // Fetch students list
    fetch("/api/users/all?role=student", {
      headers: { "Authorization": "Bearer " + token }
    })
    .then(r => r.json())
    .then(students => {
      const ul = document.getElementById("studentsList");
      students.forEach(s => {
        const li = document.createElement("li");
        li.className = "student-item";
        
        const studentInfo = document.createElement("div");
        studentInfo.className = "student-info";
        
        const name = document.createElement("div");
        name.className = "student-name";
        name.textContent = s.username;
        
        const email = document.createElement("div");
        email.className = "student-email";
        email.textContent = s.email;
        
        // Fetch feedback for this student
        fetch(`/api/feedback/student/${s._id}`, {
          headers: { "Authorization": "Bearer " + token }
        })
        .then(r => r.json())
        .then(feedbacks => {
          if (feedbacks.length > 0) {
            const feedbackList = document.createElement("ul");
            feedbackList.className = "student-feedback-list";
            
            // Show only the 3 most recent feedbacks
            const recentFeedbacks = feedbacks.slice(0, 3);
            recentFeedbacks.forEach(f => {
              const feedbackItem = document.createElement("li");
              feedbackItem.innerHTML = `
                ${f.message.substring(0, 30)}${f.message.length > 30 ? '...' : ''}
                <div class="feedback-rating">Rating: ${f.rating} ${renderStars(f.rating)}</div>
              `;
              feedbackList.appendChild(feedbackItem);
            });
            
            // Add "View more" if there are more feedbacks
            if (feedbacks.length > 3) {
              const viewMore = document.createElement("li");
              viewMore.textContent = `+${feedbacks.length - 3} more feedbacks...`;
              feedbackList.appendChild(viewMore);
            }
            
            studentInfo.appendChild(feedbackList);
          }
        })
        .catch(console.error);
        
        studentInfo.appendChild(name);
        studentInfo.appendChild(email);
        
        const btnContainer = document.createElement("div");
        btnContainer.style.display = "flex";
        btnContainer.style.gap = "8px";
        
        const feedbackBtn = document.createElement("button");
        feedbackBtn.className = "feedback-btn";
        feedbackBtn.textContent = "Give Feedback";
        feedbackBtn.onclick = () => openFeedbackModal(s._id, s.username);
        
        const viewFeedbackBtn = document.createElement("button");
        viewFeedbackBtn.className = "view-feedback-btn";
        viewFeedbackBtn.textContent = "View Feedbacks";
        viewFeedbackBtn.onclick = () => openFeedbackListModal(s._id, s.username);
        
        btnContainer.appendChild(feedbackBtn);
        btnContainer.appendChild(viewFeedbackBtn);
        
        li.appendChild(studentInfo);
        li.appendChild(btnContainer);
        
        ul.appendChild(li);
      });
    })
    .catch(console.error);

    // Feedback modal functionality
    const feedbackModal = document.getElementById("feedbackModal");
    const closeModalBtn = document.getElementById("closeModal");
    const feedbackForm = document.getElementById("feedbackForm");
    const stars = document.querySelectorAll(".star");
    const ratingInput = document.getElementById("ratingInput");
    const studentIdInput = document.getElementById("studentIdInput");
    const successToast = document.getElementById("successToast");

    // Feedback list modal elements
    const feedbackListModal = document.getElementById("feedbackListModal");
    const closeFeedbackListModalBtn = document.getElementById("closeFeedbackListModal");
    const feedbackListContent = document.getElementById("feedbackListContent");
    const feedbackListTitle = document.getElementById("feedbackListTitle");

    let currentRating = 0;
    let currentStudentId = "";
    let currentStudentName = "";

    function openFeedbackModal(studentId, studentName) {
      currentStudentId = studentId;
      currentStudentName = studentName;
      document.querySelector(".modal-title").textContent = `Feedback for ${studentName}`;
      studentIdInput.value = studentId;
      feedbackModal.classList.add("active");
    }

    function openFeedbackListModal(studentId, studentName) {
      currentStudentId = studentId;
      currentStudentName = studentName;
      feedbackListTitle.textContent = `Feedback for ${studentName}`;
      
      // Fetch feedback for this student
      fetch(`/api/feedback/student/${studentId}`, {
        headers: { "Authorization": "Bearer " + token }
      })
      .then(r => r.json())
      .then(feedbacks => {
        if (feedbacks.length === 0) {
          feedbackListContent.innerHTML = '<div class="no-feedback">No feedback given yet for this student.</div>';
        } else {
          feedbackListContent.innerHTML = '';
          feedbacks.forEach(feedback => {
            const feedbackItem = document.createElement("div");
            feedbackItem.className = "feedback-item";
            feedbackItem.innerHTML = `
              <div class="feedback-message">${feedback.message}</div>
              <div class="feedback-rating">Rating: ${feedback.rating} ${renderStars(feedback.rating)}</div>
              <div class="feedback-date">${formatDate(feedback.createdAt)}</div>
            `;
            feedbackListContent.appendChild(feedbackItem);
          });
        }
        feedbackListModal.classList.add("active");
      })
      .catch(err => {
        feedbackListContent.innerHTML = '<div class="no-feedback">Error loading feedback. Please try again.</div>';
        console.error(err);
      });
    }

    function closeFeedbackModal() {
      feedbackModal.classList.remove("active");
      // Reset form
      feedbackForm.reset();
      currentRating = 0;
      ratingInput.value = "";
      stars.forEach(star => star.classList.remove("active"));
    }

    function closeFeedbackListModal() {
      feedbackListModal.classList.remove("active");
    }

    closeModalBtn.addEventListener("click", closeFeedbackModal);
    closeFeedbackListModalBtn.addEventListener("click", closeFeedbackListModal);

    // Star rating interaction
    stars.forEach(star => {
      star.addEventListener("click", () => {
        const rating = parseInt(star.getAttribute("data-rating"));
        currentRating = rating;
        ratingInput.value = rating;
        
        stars.forEach((s, index) => {
          if (index < rating) {
            s.classList.add("active");
          } else {
            s.classList.remove("active");
          }
        });
      });
      
      // Hover effect
      star.addEventListener("mouseover", () => {
        const rating = parseInt(star.getAttribute("data-rating"));
        
        stars.forEach((s, index) => {
          if (index < rating) {
            s.style.color = "#ffc107";
          }
        });
      });
      
      star.addEventListener("mouseout", () => {
        stars.forEach((s, index) => {
          if (index >= currentRating) {
            s.style.color = "#ddd";
          }
        });
      });
    });

    // Form submission
    feedbackForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const message = document.getElementById("feedbackMessage").value;
      const rating = currentRating;
      
      if (!message || !rating) {
        alert("Please provide both feedback message and rating");
        return;
      }
      
      fetch(`/api/feedback/student/${currentStudentId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ message, rating })
      })
      .then(res => {
        if (!res.ok) throw new Error("Server rejected feedback");
        return res.json();
      })
      .then(data => {
          closeFeedbackModal();
        showSuccessToast();
      })
      .catch(err => {
        alert("Error: " + err.message);
      });
    });

    function showSuccessToast() {
      successToast.classList.add("visible");
      setTimeout(() => {
        successToast.classList.remove("visible");
      }, 3000);
    }

    // Close modal when clicking outside
    feedbackModal.addEventListener("click", (e) => {
      if (e.target === feedbackModal) {
        closeFeedbackModal();
      }
    });
    function openFeedbackListModal(studentId, studentName) {
  feedbackListTitle.textContent = `Feedback for ${studentName}`;
  feedbackListContent.innerHTML = `<div class="no-feedback">Loading…</div>`;
  feedbackListModal.classList.add("active");

  fetch(`/api/feedback/student/${studentId}`, {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(r => {
    if (!r.ok) throw new Error("Server error");
    return r.json();
  })
  .then(({ feedback }) => {
    if (feedback.length === 0) {
      feedbackListContent.innerHTML = '<div class="no-feedback">No feedback yet.</div>';
    } else {
      feedbackListContent.innerHTML = "";
      feedback.forEach(fb => {
        const item = document.createElement("div");
        item.className = "feedback-item";
        item.innerHTML = `
          <div class="feedback-message">${fb.message}</div>
          <div class="feedback-rating">
            Rating: ${fb.rating}
            <span class="feedback-stars">${
              "★".repeat(fb.rating) + "☆".repeat(5 - fb.rating)
            }</span>
          </div>
          <div class="feedback-date">${new Date(fb.createdAt).toLocaleString()}</div>
        `;
        feedbackListContent.appendChild(item);
      });
    }
  })
  .catch(err => {
    feedbackListContent.innerHTML = '<div class="no-feedback">Error loading feedback.</div>';
    console.error(err);
  });
}
 function openFeedbackListModal(studentId, studentName) {
    feedbackListTitle.textContent = `Feedback for ${studentName}`;
    feedbackListContent.innerHTML = `<div class="no-feedback">Loading…</div>`;
    feedbackListModal.classList.add("active");

    fetch(`/api/feedback/student/${studentId}`, {
      headers: { "Authorization": "Bearer " + token }
    })
    .then(r => {
      if (!r.ok) throw new Error("Server error");
      return r.json();
    })
    .then(data => {
      const feedbacks = data.feedback || [];
      if (!feedbacks.length) {
        feedbackListContent.innerHTML = '<div class="no-feedback">No feedback yet.</div>';
        return;
      }

      feedbackListContent.innerHTML = "";
      feedbacks.forEach(fb => {
        const text  = fb.message ?? fb.comment ?? "(no message)";
        const stars = "★".repeat(fb.rating) + "☆".repeat(5 - fb.rating);
        const date  = new Date(fb.createdAt).toLocaleString();

        const el = document.createElement("div");
        el.className = "feedback-item";
        el.innerHTML = `
          <div class="feedback-message">${text}</div>
          <div class="feedback-rating">Rating: ${fb.rating} ${stars}</div>
          <div class="feedback-date">${date}</div>
        `;
        feedbackListContent.appendChild(el);
      });
    })
    .catch(err => {
      feedbackListContent.innerHTML = '<div class="no-feedback">Could not load feedback.</div>';
      console.error(err);
    });
  }

  closeFeedbackListModalBtn.addEventListener("click", () => {
    feedbackListModal.classList.remove("active");
  });
  </script>
  
</body>
</html>