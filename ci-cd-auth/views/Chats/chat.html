<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Chat • CI/CD</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* GLOBAL */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#FFF;color:#1f2328;line-height:1.5}

    /* HEADER */
    header{position:fixed;top:0;left:0;width:100%;padding:16px 10%;background:#FFF;border-bottom:1px solid #d8dee4;display:flex;align-items:center;z-index:10}
    .logo-container{display:flex;align-items:center;gap:12px}
    .logo-img{width:32px;height:32px;fill:#657EEF}
    .logo-text{font-size:1.25rem;font-weight:600;color:#657EEF}
    .nav-links{list-style:none;display:flex;gap:24px;margin-left:auto}
    .nav-links a{text-decoration:none;color:#1f2328;font-weight:500;font-size:14px;padding:8px 0;position:relative}
    .nav-links a:hover,.nav-links a.active{color:#657EEF}
    .nav-links a.active::after{content:'';position:absolute;bottom:0;left:0;width:100%;height:2px;background:#657EEF}

    /* MAIN */
    main{padding:100px 10% 40px;max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:16px}
    h1{font-size:2rem}

    .chat-select{display:flex;align-items:center;gap:8px}
    .chat-select select{flex:1;padding:10px 12px;border:1px solid #d8dee4;border-radius:8px;background:#FFF}
    .chat-select button{padding:10px 24px;background:#657EEF;color:#FFF;border:none;border-radius:999px;font-weight:600;transition:.2s}
    .chat-select button:hover{background:#4c5bc5}

    /* CARD */
    .chat-card{background:#FFF;border:1px solid #d8dee4;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);overflow:hidden;display:flex;flex-direction:column;height:400px}
    .chat-window{flex:1;padding:16px;overflow-y:auto}

    /* BUBBLES */
    .message{max-width:70%;padding:10px 14px 16px;border-radius:18px;margin-bottom:14px;position:relative;font-size:.9rem;line-height:1.45;animation:fadeIn .25s ease-out;box-shadow:0 2px 4px rgba(0,0,0,.08)}
    .message.me{margin-left:auto;background:linear-gradient(135deg,#6d7cff,#5372ff);color:#FFF;border-bottom-right-radius:4px}
    .message.them{background:#F0F2F5;color:#1f2328;border-bottom-left-radius:4px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .message.me::after,.message.them::after{content:'';position:absolute;bottom:0;width:14px;height:14px;background:inherit}
    .message.me::after{right:-6px;clip-path:polygon(0 0,100% 0,100% 100%)}
    .message.them::after{left:-6px;clip-path:polygon(0 0,0 100%,100% 0)}
    .meta{display:block;font-size:.7rem;opacity:.8;margin-bottom:4px}
    .message.me .meta{text-align:right;color:#dfe3ff}
    .message.them .meta{color:#6b7280}
    .message button{position:absolute;top:4px;right:4px;width:18px;height:18px;border:none;border-radius:50%;background:#ff6b6b;color:#fff;font-size:10px;line-height:18px;opacity:0;transition:.2s}
    .message:hover button{opacity:1}
    .message button:hover{background:#e45656;cursor:pointer}

    /* INPUT */
    .chat-input{display:flex;align-items:flex-end;padding:12px 16px;background:#FAFAFA;border-top:1px solid #d8dee4}
    .chat-input textarea{flex:1;padding:12px;border:1px solid #d8dee4;border-radius:8px;resize:none;font-family:inherit;font-size:14px}
    .send-btn{margin-left:8px;padding:12px 24px;background:#657EEF;color:#FFF;border:none;border-radius:999px;font-weight:600;transition:.2s}
    .send-btn:hover{background:#4c5bc5}

    @media(max-width:768px){main{padding:120px 5% 20px}.chat-card{height:300px}.message{max-width:85%}}
  </style>
</head>

<body>
  <header>
    <div class="logo-container">
      <svg class="logo-img" viewBox="0 0 24 24"><path d="M12 0C5.374..." /></svg>
      <span class="logo-text">CI/CD</span>
    </div>
    <ul class="nav-links">
      <li><a href="/">Home</a></li>
      <li><a href="/video/courses">Courses</a></li>
      <li><a href="/chat" class="active">Chat</a></li>
      <li><a href="#" onclick="logout()">Logout</a></li>
    </ul>
  </header>

  <main>
    <h1>Chat</h1>

    <div class="chat-select">
      <label for="userSelect">Chat&nbsp;with:</label>
      <select id="userSelect"><option>Loading…</option></select>
      <button id="openChat">Open Chat</button>
    </div>

    <div class="chat-card">
      <div class="chat-window" id="messages"></div>
      <div class="chat-input">
        <textarea id="msgInput" rows="2" placeholder="Type a message…"></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
    </div>
  </main>

  <script>
    function logout(){sessionStorage.removeItem("token");window.location="/login";}

    document.addEventListener("DOMContentLoaded",async()=>{
      const token=sessionStorage.getItem("token")||localStorage.getItem("token");
      if(!token)return window.location.replace("/login");

      const {role:myRole,id:myId}=JSON.parse(atob(token.split('.')[1]||''));
      const counterpart=myRole==="lecturer"?"student":"lecturer";

      const sel=document.getElementById("userSelect"), box=document.getElementById("messages");
      const userMap={}; // id -> username

      /* populate dropdown and username map */
      const uRes=await fetch(`/api/users/all?role=${counterpart}`,{headers:{Authorization:"Bearer "+token}});
      const users=await uRes.json();
      sel.innerHTML='<option value="">-- select --</option>';
      users.forEach(u=>{
        userMap[u._id]=u.username;
        const opt=document.createElement("option");
        opt.value=u._id; opt.textContent=`${u.username} (${u.role})`;
        sel.appendChild(opt);
      });

      document.getElementById("openChat").onclick=()=>openChat(sel.value);

      async function openChat(uid){
        if(!uid)return alert("Pick someone");window.currentChat=uid;
        const res=await fetch(`/api/chat/conversation/${uid}`,{headers:{Authorization:"Bearer "+token}});
        const msgs=await res.json();
        box.innerHTML="";
        msgs.forEach(m=>{
          const senderId   = typeof m.sender === "object" ? m.sender._id  : m.sender;
          const senderName = senderId===myId
                                ? "Me"
                                : (typeof m.sender === "object" ? m.sender.username : (userMap[senderId]||"Unknown"));

          const ts  = new Date(m.timestamp);
          const metaDate = ts.toLocaleDateString([], {month:"short",day:"numeric",year:"numeric"});
          const metaTime = ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

          const div=document.createElement("div");
          div.className="message "+(senderId===myId?"me":"them");
          div.innerHTML=`<span class="meta">${senderName} • ${metaDate} • ${metaTime}</span>${m.content}`;

          if(myRole==="lecturer"){
            const del=document.createElement("button");
            del.textContent="✕";
            del.onclick=async()=>{
              await fetch(`/api/chat/${m._id}`,{method:"DELETE",headers:{Authorization:"Bearer "+token}});
              openChat(uid);
            };
            div.appendChild(del);
          }
          box.appendChild(div);
        });
        box.scrollTop=box.scrollHeight;
      }

      document.getElementById("sendBtn").onclick=async()=>{
        const txt=document.getElementById("msgInput").value.trim();
        if(!txt||!window.currentChat)return;
        await fetch("/api/chat/send",{
          method:"POST",
          headers:{'Content-Type':'application/json',Authorization:"Bearer "+token},
          body:JSON.stringify({recipientId:window.currentChat,content:txt})
        });
        document.getElementById("msgInput").value="";
        openChat(window.currentChat);
      };
    });
  </script>
</body>
</html>
